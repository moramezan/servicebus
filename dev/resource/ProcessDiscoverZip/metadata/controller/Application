{
    "type": "Ext.app.Controller",
    "reference": {
        "name": "items",
        "type": "array"
    },
    "codeClass": null,
    "userConfig": {
        "designer|userClassName": "Application",
        "isAsyncApexJobFinished": false,
        "isAsyncApexJobStarted": false
    },
    "configAlternates": {
        "isAsyncApexJobFinished": "boolean",
        "isAsyncApexJobStarted": "boolean"
    },
    "designerId": "82c204d7-ffa5-4759-a8cc-79105b35ef9f",
    "customConfigs": [
        {
            "group": "(Custom Properties)",
            "name": "isAsyncApexJobFinished",
            "type": "string"
        },
        {
            "group": "(Custom Properties)",
            "name": "isAsyncApexJobStarted",
            "type": "string"
        }
    ],
    "cn": [
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "gridpanel",
                "designer|params": [
                    "target"
                ],
                "designer|targetType": null,
                "fn": "onGridpanelAfterRender",
                "implHandler": [
                    "Ext.log('[Discover.controller.Application] heard gridpanel afterrender event');",
                    "",
                    "var me = this;",
                    "var store = Ext.getStore('AsyncApexJob');",
                    "var jobAlreadyFinished = Ext.Array.contains(['Aborted', 'Completed', 'Failed'], AsyncApexJob.Status);",
                    "",
                    "Ext.log('[Discover.controller.Application] start polling AsyncApexJob store');",
                    "store.load(function lambda() {",
                    "    //redraw progress bar",
                    "    var job = store.getAt(0);",
                    "    job.draw(me.getProgressBar());",
                    "    job.mask(me.getGrid());",
                    "",
                    "    if (!me.isAsyncApexJobFinished) {",
                    "        //asyncapexjob not finished yet",
                    "        Ext.log('[Discover.controller.Application] job unfinished, polling AsyncApexJob store');",
                    "",
                    "        //poll, but only enthusiastically IF the job has actually started",
                    "        Ext.Function.defer(function() {store.load(lambda);}, me.isAsyncApexJobStarted ? 10 : 1000);",
                    "    } else {",
                    "        //quit polling",
                    "        Ext.log('[Discover.controller.Application] found isAsyncApexJobFinished, stop polling AsyncApexJob store');",
                    "",
                    "        if (!jobAlreadyFinished && job.get('Status') == 'Completed') {",
                    "            //job was busy, then job became Completed, so redirect to retURL (or Processes list view)",
                    "            Ext.Function.defer(function() {window.location = URLFOR[retURL];}, 1000);",
                    "        }",
                    "    }",
                    "});"
                ],
                "name": "afterrender",
                "scope": "me"
            },
            "designerId": "d2231564-a5ca-4fdf-a040-66226f968502"
        },
        {
            "type": "applicationaction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|params": [
                    "store",
                    "records",
                    "successful",
                    "eOpts"
                ],
                "fn": "onAsyncApexJobStart",
                "implHandler": [
                    "//note this event is singular",
                    "Ext.log('[Discover.controller.Application] heard asyncapexjobstart event');",
                    "this.isAsyncApexJobStarted = true;",
                    "",
                    "var me = this;",
                    "var store = Ext.getStore('Processes');",
                    "",
                    "Ext.log('[Discover.controller.Application] start polling Processes store');",
                    "store.load(function lambda(records, operation, success) {",
                    "    if (!me.isAsyncApexJobFinished) {",
                    "        //job not finished",
                    "        Ext.log('[Discover.controller.Application] job unfinished, polling Processes store');",
                    "",
                    "        //poll, it masks, but we do want AsyncApexJob to get the lion's share of the updates",
                    "        store.load(lambda);",
                    "    } else {",
                    "        //job finished",
                    "        Ext.log('[Discover.controller.Application] found isAsyncApexJobFinished, stop polling Processes store');",
                    "    }",
                    "});"
                ],
                "name": "asyncapexjobstart",
                "scope": "this",
                "single": true
            },
            "designerId": "758f1ee6-8101-42de-9ce7-c99286edcc30"
        },
        {
            "type": "applicationaction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "onAsyncApexJobFinish",
                "implHandler": [
                    "//note this event is singular",
                    "Ext.log('[Discover.controller.Application] heard asyncapexjobfinish event');",
                    "this.isAsyncApexJobFinished = true;"
                ],
                "name": "asyncapexjobfinish",
                "scope": "this",
                "single": true
            },
            "designerId": "900050cf-d099-4672-b7f9-95e1c98d4b6c"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "ProgressBar",
                "selector": "#progressbar",
                "xtype": "Ext.ProgressBar"
            },
            "designerId": "1731ab06-bb1c-4bdc-ae79-64f7524229d8"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "Grid",
                "selector": "#grid",
                "xtype": "Ext.grid.Panel"
            },
            "designerId": "86a646dd-4330-4f64-9053-2429e0db5a70"
        }
    ]
}