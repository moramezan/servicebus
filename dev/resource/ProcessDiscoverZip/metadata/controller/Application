{
    "type": "Ext.app.Controller",
    "reference": {
        "name": "items",
        "type": "array"
    },
    "codeClass": null,
    "userConfig": {
        "designer|userClassName": "Application",
        "isAsyncApexJobFinished": false,
        "isAsyncApexJobStarted": false
    },
    "name": "MyController",
    "configAlternates": {
        "isAsyncApexJobFinished": "boolean",
        "isAsyncApexJobStarted": "boolean"
    },
    "designerId": "3684d753-8954-4c0a-91c0-004ece690203",
    "customConfigs": [
        {
            "group": "(Custom Properties)",
            "name": "isAsyncApexJobFinished",
            "type": "string"
        },
        {
            "group": "(Custom Properties)",
            "name": "isAsyncApexJobStarted",
            "type": "string"
        }
    ],
    "cn": [
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "gridpanel",
                "designer|params": [
                    "target"
                ],
                "fn": "onGridpanelAfterRender",
                "implHandler": [
                    "Ext.log('[Discover.controller.Application] heard gridpanel afterrender event');",
                    "",
                    "var me = this;",
                    "var store = Ext.getStore('AsyncApexJobs');",
                    "var jobAlreadyFinished = Ext.Array.contains(['Aborted', 'Completed', 'Failed'], AsyncApexJob.Status);",
                    "",
                    "Ext.log('[Discover.controller.Application] start polling AsyncApexJob store');",
                    "store.load(function lambda() {",
                    "    //redraw progress bar",
                    "    var job = store.getAt(0);",
                    "    job.draw(me.getProgressBar());",
                    "    job.mask(me.getGrid());",
                    "",
                    "    if (!me.isAsyncApexJobFinished) {",
                    "        //asyncapexjob not finished yet",
                    "        Ext.log('[Discover.controller.Application] job unfinished, polling AsyncApexJob store');",
                    "",
                    "        //poll, but only enthusiastically IF the job has actually started",
                    "        Ext.Function.defer(function() {store.load(lambda);}, me.isAsyncApexJobStarted ? 10 : 1000);",
                    "    } else {",
                    "        //quit polling",
                    "        Ext.log('[Discover.controller.Application] found isAsyncApexJobFinished, stop polling AsyncApexJob store');",
                    "",
                    "        if (!jobAlreadyFinished && job.get('Status') == 'Completed') {",
                    "            //job was busy, then job became Completed, so redirect to retURL (or Processes list view)",
                    "            Ext.Function.defer(function() {window.location = URLFOR[retURL];}, 1000);",
                    "        }",
                    "    }",
                    "});"
                ],
                "name": "afterrender",
                "scope": "me"
            },
            "name": "onGridpanelAfterRender",
            "designerId": "f581cdbc-954c-4cce-b0f5-e96a42c9cde3"
        },
        {
            "type": "applicationaction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|params": [
                    "store",
                    "records",
                    "successful",
                    "eOpts"
                ],
                "fn": "onAsyncApexJobStart",
                "implHandler": [
                    "//note this event is singular",
                    "Ext.log('[Discover.controller.Application] heard asyncapexjobstart event');",
                    "this.isAsyncApexJobStarted = true;",
                    "",
                    "var me = this;",
                    "var store = Ext.getStore('Processes');",
                    "",
                    "Ext.log('[Discover.controller.Application] start polling Processes store');",
                    "store.load(function lambda(records, operation, success) {",
                    "    if (!me.isAsyncApexJobFinished) {",
                    "        //job not finished",
                    "        Ext.log('[Discover.controller.Application] job unfinished, polling Processes store');",
                    "",
                    "        //poll, it masks, but we do want AsyncApexJob to get the lion's share of the updates",
                    "        store.load(lambda);",
                    "    } else {",
                    "        //job finished",
                    "        Ext.log('[Discover.controller.Application] found isAsyncApexJobFinished, stop polling Processes store');",
                    "    }",
                    "});"
                ],
                "name": "asyncapexjobstart",
                "scope": "this",
                "single": true
            },
            "name": "onAsyncApexJobStart",
            "designerId": "c74f0cbf-1b54-4091-942b-cc21e7495623"
        },
        {
            "type": "applicationaction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "onAsyncApexJobFinish",
                "implHandler": [
                    "//note this event is singular",
                    "Ext.log('[Discover.controller.Application] heard asyncapexjobfinish event');",
                    "this.isAsyncApexJobFinished = true;"
                ],
                "name": "asyncapexjobfinish",
                "scope": "this",
                "single": true
            },
            "name": "onAsyncApexJobFinish",
            "designerId": "c34d0351-b3a8-4a66-b17a-91cf10936f67"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "ProgressBar",
                "selector": "#progressbar",
                "xtype": "Ext.ProgressBar"
            },
            "name": "ProgressBar",
            "designerId": "f6aa230d-938e-4bcf-81f0-53f7e0ae5ac5"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "Grid",
                "selector": "#grid",
                "xtype": "Ext.grid.Panel"
            },
            "name": "Grid",
            "designerId": "c55e7a03-940f-4b36-bccb-25b037003440"
        }
    ]
}