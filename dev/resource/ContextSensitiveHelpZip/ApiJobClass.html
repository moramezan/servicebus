<h1>
    ServiceBus.Job Class
</h1>

<!--
 ! Gonna try here not to say "Message" unless it refers to "Message__c"
 !-->

<p>
    A Job is used to inject entry point events into the Service Bus. Jobs can be started
    in any context including triggers, batch apex, future methods, and before or after callouts.
</p>

<p>
    You can instantiate a Job in one of the following ways:
</p>

<table>
        <tr>
            <th>Usage</th>
            <th>Constructor Signature</th>
        </tr>
        <tr>
            <td>Simple event</td>
            <td><code>Job(String sequence, Id recordId)</code></td>
        </tr>
        <tr>
            <td>Simple event</td>
            <td><code>Job(Type service, Id recordId)</code></td>
        </tr>
        <tr>
            <td>Single event</td>
            <td><code>Job(Map&lt;String,Object&gt;)</code></td>
        </tr>
        <tr>
            <td>Multiple events</td>
            <td><code>Job(List&lt;Map&lt;String,Object&gt;&gt;)</code></td>
        </tr>
        <!--
        <tr>
            <td>Lightning Process Builder</td>
            <td><code>enqueue(String sequenceName, Id recordId)</code></td>
        </tr>
        <tr>
            <td>Salesforce Cloud Flows</td>
            <td><code>invoke(Process.PluginRequest request)</code></td>
        </tr>
        -->
</table>

<!--
 ! Stolen from here:
 ! https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_class_System_Queueable.htm
 !-->

<p>
    Then, submit your Job for asynchronous execution by calling <code>System.enqueueJob</code> and
    passing it the instance of your Job, for example:
</p>

<pre>
String sequence = 'Payroll_Calculation';
Id companyId = UserInfo.getOrganizationId();

//submit a simple event to Enterprise Service Bus
Queueable job = new ServiceBus.Job(sequence, companyId);
Id jobId = System.enqueueJob(job);
</pre>

<h1>
    ServiceBus.Job Constructors
</h1>

<h2>
    Simple event constructor
</h2>

<p>
    Sends a known Id to a sequence. This short-hand method sets two event parameters for you.
    Use this constructor for simple events that only need to point at an sObject.
</p>

<p>
    <code>global ServiceBus.Job(String sequence, Id recordId)</code>
</p>

<dl>
    <dt>sequence</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Name of the sequence the data is destined for. This is set on the <code>Sequence</code> event parameter for your convenience.</dd>
    
    <dt>recordId</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_id.htm" target="_blank">Id</a></dd>
    <dd>Id of some record that the sequence will operate on. This is set on the <code>RecordId</code> event parameter for your convenience.</dd>
</dl>

<h2>
    Single event constructor
</h2>

<p>
    Sends an event with any number of event parameters to a sequence. Use this constructor for
    events that need to carry many keys and values.
</p>

<p>
    <code>global ServiceBus.Job(Map&lt;String,Object&gt; event)</code>
</p>

<dl>
    <dt>event</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_map.htm" target="_blank">Map&lt;String,Object&gt;</a></dd>
    <dd>An event, which must carry a <code>ToSequence</code> parameter with a string value.</dd>
</dl>

<h2>
    Multiple event constructor
</h2>

<p>
    Sends multiple events with any number of event parameters to sequences. Use this constructor
    to bulkify multiple events at once without calling enqueueJob inside of a loop.
</p>

<p>
    <code>global ServiceBus.Job(List&lt;Map&lt;String,Object&gt;&gt; events)</code>
</p>

<dl>
    <dt>events</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_list.htm" target="_blank">List&lt;Map&lt;String,Object&gt;&gt;</a></dd>
    <dd>A collection of multiple events, each of which must carry an <code>ToSequence</code> parameter with a string value.</dd>
</dl>

<!--
 ! TODO
 !-->
<!--
<h2>
    Blob Signature
</h2>

<p>
    <code>global ServiceBus.Job(String sequenceName, Blob entityData)</code>
</p>

<dl>
    <dt>sequenceName</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Name of the sequence the data is destined for. This sets <code>SequenceName</code> as a convenience.</dd>
    
    <dt>entityData</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_blob.htm" target="_blank">Blob</a></dd>
    <dd>Blob representation of the data the sequence will operate on. This sets <code>RecordId</code> as a convenience.</dd>
</dl>
-->

<h1>
    ServiceBus.Job Methods
</h1>

<h2>
    Enqueue
</h2>

<p>
    Lightning Processes can be enhanced using Jobs. This method has the 
    <code>@InvocableMethod</code> annotation. Use this for asynchronous heavy lifting from
    Lightning Process Builder.
</p>

<p>
    <code>global List&lt;Id&gt; enqueue(List&lt;SimpleEvent&gt; events)</code>
</p>

<dl>
    <dt>toSequence</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Indicates which sequence the event is destined for.</dd>
    
    <dt>recordId</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_id.htm" target="_blank">Id</a></dd>
    <dd>Indicates which sObject the sequence will operate on.</dd>
</dl>

<fieldset>
    <legend>Note</legend>
    The Invocable Action signature is a Simple Event with variables for ToSequence and RecordId.
    Lightning Process Builder requires that all Invocable Variables be known at design time.
</fieldset>

<h2>
    Invoke
</h2>

<p>
    Cloud Flows can be enhanced using Jobs. This class implements the
    <code>Process.Plugin</code> interface. Use this to deal with high data volumes from Visual
    Workflow Cloud Flow Designer.
</p>

<p>
    <code>global Process.PluginResult invoke(Process.PluginRequest request)</code>
</p>

<dl>
    <dt>request</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_plugin_request.htm" target="_blank">Process.PluginRequest</a></dd>
    <dd>The request class itself is constructed with a Map&lt;String,Object&gt; that directly becomes the event parameters.</dd>
</dl>

<p>
    When the Process.PluginResult is returned, its parameters will contain an <code>QueueableId</code> key identifying the submitted Job.
</p>

<fieldset>
    <legend>Note</legend>
    <p>
        Advanced users can exploit the Process.Plugin implementation to instantiate Jobs dynamically
        without creating a package dependency.
    </p>
    
    <p>
        Use this when authoring and distributing AppExchange packages that need to submit events
        into Enterprise Service Bus, for example:
    </p>
    
    <pre>
        //assemble input event parameters
        Map&lt;String,Object&gt; inputEvent = new Map&lt;String,Object&gt;();
        inputEvent.put('SequenceName', 'Generate_PDF_Statements');
        
        //immediately submit event to Enterprise Service Bus
        Process.Plugin job = (Process.Plugin)Type.forName('ServiceBus.Job').newInstance();
        Process.PluginResult result = job.invoke(new Process.PluginRequest(inputEvent));
        
        //access queueable job id
        Id queueableId = result.OutputParameters.get('JobId');
        System.debug(queueableId); //707j0000008MzD6
    </pre>
</fieldset>
