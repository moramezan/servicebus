<h1>
    Service Definition
</h1>

<!--
 ! Marker Interface, Marker Inner Class, Marker Properties are all "Annotations" (not in Java sense)
 ! There are some other good phraseology here like "Trait" (compile time) and "Mixin" (run time)
 !-->

<!--
 ! Trying not to say "Service" unless we refer to "ApexClass"
 ! I like also "Service Definition" ... do we change the label?
 !-->

<p>
    Inside each Apex Service is a Service Definition class.
    This inner class controls how the service is displayed and how it behaves.
    The Service Bus discovers service definitions automatically.
</p>

<p>
    This example shows the bare minimum service definition:
</p>

<pre>
global class ExampleService extends Abstract.Service {
    
    global class Definition extends Abstract.Service.Definition {
        String Description = 'Outputs one event identical to the input event.';
    }
    
}
</pre>

<h1>
    Attributes
</h1>

<!--
 ! TODO
 ! - link to Chunking
 ! - link to Callouts
 !-->

<p>
    The service definition affects how the service is executed and
    is used to generate user interfaces.
</p>

<dl>
    <dt>Description</dt>
    <dd><strong>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></strong></dd>
    <dd><strong>Required description that explains what this service does in simple terms.</strong></dd>
    
    <dt>Tag</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Optional grouping tag that can be used to categorize related services together.</dd>
    
    <dt>Label</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Optional friendly label to be displayed instead of the apex class name.</dd>
    
    <dt>Icon</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Optional icon name from the <a href="resources/Api/index_abc.png" target="_blank">Silk library</a> that will display alongside steps of this type.</dd>
    
    <dt>Cardinality</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Optional indicator of the ratio of output events to input events: eg <code>Fewer</code> outputs (Aggregate), <code>Zero</code> for no outputs (Terminate), <code>One</code> for a single output (Wiretap), <code>Many</code> for a split.</dd>

    <dt>HelpUrl</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Optional link to service documentation. This will be displayed alongside steps of this type.</dd>
    
    <dt>Limits</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">Integer</a></dd>
    <dd>Optional number of times this service can run in one execution context. For example, <code>100</code> for a service that only issues a SOQL query.</dd>

    <dt>Inputs</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_map.htm" target="_blank">Map&lt;String,String&gt;</a></dd>
    <dd>Optional friendly descriptions of the input event parameters required by this process.</dd>
    
    <dt>Outputs</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_map.htm" target="_blank">Map&lt;String,String&gt;</a></dd>
    <dd>Optional friendly descriptions of the output event parameters emitted by this process. Not to be confused with events themselves.</dd>
    
    <dt>ServiceSetting</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_custom_settings.htm" target="_blank">SObject</a></dd>
    <dd>Optional <em>prototype object</em> of a Custom Setting to be used for Process-specifics settings. Data of this type are manageable on each process, and are surfaced inside the Sequence Builder.</dd>
    
    <dt>StepConfig</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_sobject.htm" target="_blank">SObject</a></dd>
    <dd>Optional <em>prototype object</em> of a Custom Object to be used for Step-specific config. Records of this type are editable on each step, and are surfaced inside the Sequence Builder.</dd>
</dl>

<p>
    This example Marker Inner Class uses all of the above:
</p>

<pre>
//Service Summary Inner Class
global class Summary {
    String Description = 'This process tweets from a Twitter account.';
    String Tag = 'Social';
    String Name = 'Twitter';
    String Icon = 'comment';
    Integer Cardinality = 1; //one input event always emits exactly one output event
    String HelpUrl = Page.TwitterHelp.getUrl();
    String Limits = 25; //leave half of 50 (Total number of HTTP callouts permitted)
    Map&lt;String,Object&gt; Inputs = new Map&lt;String,Object&gt;{'acme:Body' => 'String of the tweet body.'};
    Map&lt;String,Object&gt; Outputs = new Map&lt;String,Object&gt;{'acme:TweetId' => 'String of tweet Id.'}
    SObject ServiceSetting = TwitterSetting__c.SObjectType.newSObject();
    SObject StepConfig = TwitterConfig__c.SObjectType.newSObject();
}
</pre>

<h1>
    Marker Properties
</h1>

<p>
    These properties on an Apex Class may be populated by a Service. They can be read during execution.
</p>

<dl>
    <dt>Event</dt>
    <dd><strong>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></strong></dd>
    <dd><strong>Required property containing the map of input event parameters, in JSON serialized form.</strong></dd>
    
    <dt>StepConfig</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">Custom Object</a></dd>
    <dd>Concrete custom object whose fields are populated with any Step-specific configuration, if that trait is adopted by this process.</dd>
    
    <dt>AllowsCallouts</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_boolean.htm" target="_blank">Boolean</a></dd>
    <dd>False when handling execution logic and true when handling callout logic, if that trait is adopted by this process.</dd>
</dl>

<p>
    Example
</p>

<pre>
//Service Marker Properties
global String Event;
global TwitterConfig__c StepConfig;
global Boolean AllowsCallouts;
</pre>


<h1>
    Marker Methods
</h1>

<h2>
    callouts
</h2>

<p>
    Optional method, implemented for processes that perform callouts.
</p>

<p>
    <code>override protected void callouts(Map&lt;String,Object&gt; inputEvent)</code>
</p>

<p>
    Any web services or HTTP callouts must be performed via this method. The response body
    can be shared with the <code>execute</code> method by using class properties. For example:
</p>

<pre>
override protected void callouts(Map&lt;String,Object&gt; inputEvent) {
    HttpRequest request = new HttpRequest();
    request.setEndpoint('http://headers.jsontest.com/');
    request.setMethod('GET');
    this.Content = new Http().send(request).getBody();
}
</pre>

<h2>
    execute
</h2>

<p>
    Required method that contains the executable logic of a Service.
</p>

<p>
    <code>override protected List&lt;Map&lt;String,Object&gt;&gt; execute(Map&lt;String,Object&gt; inputEvent)</code>
</p>

<p>
    Any DML operations must be performed via this method. Returns a list of zero, one or many output events.
</p>

<pre>
override protected List&lt;Map&lt;String,Object&gt;&gt; execute(Map&lt;String,Object&gt; inputEvent) {
    Map&lt;String,Object&gt; outputEvent = inputEvent.clone();
    outputEvent.put('c:Debug', 'Hello world!');
    return new List&lt;Map&lt;String,Object&gt;&gt;{outputEvent};
}
</pre>

<h1>
    Marker Interfaces
</h1>

<h2>
    Database.AllowsCallouts
</h2>

<p>
    Indicates this process will attempt to make HTTP callouts.
</p>

<p>
    This marker interface has no methods. See example:
</p>

<pre>
//Service Marker Interface
global class TwitterProcess extends BaseProcess implements Database.AllowsCallouts {
    
    //Service Marker Inner Class
    global class Summary {
        String Description = 'Makes an HTTP callout then performs some DML.';
    }
     
    override protected void callouts(Map&lt;String,Object&gt; inputEvent) {
        //http callouts here (called first)
    }
    
    override protected List&lt;Map&lt;String,Object&gt;&gt; execute(Map&lt;String,Object&gt; inputEvent) {
        //dml operations here (called second)
        return new List&lt;Map&lt;String,Object&gt;&gt;{inputEvent};
    }
}
</pre>
