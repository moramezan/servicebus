<h1>
    Grouping messages under a common business identifier
</h1>

<p>
    The objective of this tutorial is to demonstrate the grouping of related messages under a common
    business identifier.
</p>

<ul>
    <li>
        <p>
            <strong>Related Messages</strong>
        </p>
        <p>
            Consider a <em>Supplier Invoice</em> that must be paid via a <em>Funds Transfer
            Instruction.</em> The Supplier Invoice and the Funds Transfer Instruction are two
            separate source documents generated on different systems. Both documents are however
            related by the payment process and therefore require grouping under a common business
            identifier.
        </p>
    </li>
    <li>
        <p>
            <strong>Common Business Identifier</strong>
        </p>
        <p>
            An internal Salesforce ID such as <code>066b0000001RJct</code> may not be useful from an
            end user perspective. An identifier such as <code>INVOICE-123</code> or
            <code>PMT2345</code> conveys useful meaning and is therefore a better choice for a
            common business identifier.
        </p>
        <p>
            Business identifiers naturally vary on a case by case basis. It is for this reason that
            the framework enables the system configurator to define what part of structured data
            will act as the common identifier across disparate source documents.
        </p>
    </li>
</ul>

<p>
    Expected duration: 15 minutes.
</p>

<h2>
    Scenario
</h2>

<p>
    We will model:
</p>

<ul>
    <li>the receipt of a Purchase Invoice,</li>
    <li>the payment of that Purchase Invoice using a Funds Transfer Instruction,</li>
    <li>the relationship between these two documents using their respective business references,</li>
</ul>

<p>
    To achieve this, we will:
</p>

<ul>
    <li>create two custom objects: <code>PurchaseInvoice__c</code> and <code>Payment__c</code>,</li>
    <li>create a custom <em>Pay Invoice</em> service that simulates the payment of supplier
        invoices,</li>
    <li>use the <em>Audit Initializer</em> and <em>Audit Writer</em> processes to
        relate the Purchase Invoice Reference (<code>PurchaseInvoice__c.PurchaseRef__c</code>) and
        the Payment Reference (<code>Payment__c.PaymentRef__c</code>).</li>
</ul>

<h2>
    Prerequisites:
</h2>

<p>
    The creation of custom objects and processes will normally be carried out by the developer(s) in
    your organisation.
</p>

<fieldset>
    <legend>Note</legend>
    For more detailed instructions on creating processes, see the <a href="?topic=GuideDevelopers">
    Process Developer's Guide</a>.
</fieldset>

<ol>
    <li>
        <p>
            Create the Purchase Invoice object with a Reference field.
        </p>
        <p>
            Click Setup &gt; Create &gt; Objects &gt; New Custom Object
        </p>
    </li>
    <li>
        <p>
            Name the object <code>PurchaseInvoice</code>
        </p>
        <p>
            <img src="resources/TutorialMessageGrouping/PurchaseInvoiceDefinition.png" />
        </p>
    </li>
    <li>
        <p>
            Make sure it has a Auto Number <code>Name</code> field
        </p>
        <p>
            <img src="resources/TutorialMessageGrouping/PurchaseInvoiceAutoNumber.png" />
        </p>
    </li>
    <li>
        <p>
            Create a single text Reference field called <code>Invoice Reference</code>
        </p>
        <p>
            <img src="resources/TutorialMessageGrouping/PurchaseInvoiceReference.png" />
        </p>
    </li>
    <li>
        <p>
            Create a tab for the <code>PurchaseInvoice</code> object.
        </p>
        <p>
            Select Setup &gt; Create &gt; Tabs &gt; New
        </p>
        <p>
            Select a tab style and choose <code>PurchaseInvoice</code> for the Object
        </p>
        <p>
            <img src="resources/TutorialMessageGrouping/PurchaseInvoiceTab.png" />
        </p>
        <p>
            Click <em>Next</em>, then <em>Next</em>.
        </p>
        <p>
            On the applications screen, ensure that only the <em>Enterprise Service Bus Application
            </em>is selected then click <em>Save</em>.
        </p>
    </li>
    <li>
        <p>
            Create the <code>Payment</code> object with a reference field.
        </p>
        <p>
            Click Setup &gt; Create &gt; Objects &gt; New Custom Object
        </p>
    </li>
    <li>
        <p>
            Name the object <code>Payment</code>
        </p>
        <p>
            <img src="resources/TutorialMessageGrouping/PaymentDefinition.png" />
        </p>
    </li>
    <li>
        <p>
            Make sure it has a Auto Number <code>Name</code> field.
        </p>
        <p>
            <img src="resources/TutorialMessageGrouping/PaymentAutoNumber.png" />
        </p>
    </li>
    <li>
        <p>
            Create a single text Reference field called <code>PaymentReference</code>
        </p>
        <p>
            <img src="resources/TutorialMessageGrouping/PaymentReference.png" />
        </p>
    </li>
    <li>
        <p>
            Create a tab for the <code>PurchaseInvoice</code> object.
        </p>
        <p>
            Select Setup &gt; Create &gt; Tabs &gt; New
        </p>
        <p>
            Select a tab style and choose <code>Payment</code> for the Object
        </p>
        <p>
            <img src="resources/TutorialMessageGrouping/PaymentTab.png" />
        </p>
        <p>
            Click <em>Next</em>, then <em>Next</em>.
        </p>
        <p>
            On the applications screen, ensure that only the <em>Enterprise Service Bus Application
            </em>is selected then click <em>Save</em>.
        </p>
    </li>
    <li>
        <p>
            Create the <em>Pay Invoice</em> process that simulates the payment of a
            hypothetical inbound Purchase Invoice.
        </p>
        <p>
            Click Setup &gt; Develop &gt; Apex Classes &gt; New
        </p>
        <p>
            Paste the following code into the code window, then click <em>Save</em>.
        </p>
        <pre>
global class PayInvoice {
    
    global class Summary {
        String Tag = 'Example';
        String Name = 'Pay Invoice';
        String Description = 'Demo - takes invoice and creates payment advice';
        String Icon = 'money';
        
        Map&lt;String,String> Outputs = new Map&lt;String,String&gt;{
            'RecordId' =>'ID modified to reference the payment'
        };
    }
    
    override global String toString() {
        Map&lt;String,Object&gt; inputEvent = (Map&lt;String,Object&gt;)Json.deserializeUntyped(this.Event); //input message
        // simulate payment of invoice with payment reference  
        String paymentReference = 'PMT-'+ Math.round(Math.random()*1000);  
        Payment__c payment = new Payment__c(PaymentReference__c = paymentReference);
        insert payment;
        
        // change the underlying document pointed at by the notification  
        inputEvent.put('RecordId', payment.Id);  
        
        //output message(s)
        return new List&lt;Map&lt;String,Object&gt;&gt;{inputEvent};
    }
}</pre>
    </li>
</ol>

<h2>
    Instructions
</h2>

<p>
    First, re-discover the catalogue of processes. This will avail the <em>Pay Invoice</em>
    process in the Sequence Builder. For specific details, see the
    <a href="?topic=TutorialProcessDiscovery">Process Discovery Tutorial</a>.
</p>

<ol>
    <li>
        <p>
            Create a Sequence named <code>Purchase</code>
        </p>
        <p>
            <img src="resources/TutorialMessageGrouping/PurchaseSequence.png" />
        </p>
    </li>
    <li>
        <p>
            Using the <strong>New Step</strong> button, add the following steps to the sequence:
        </p>
        <ul>
            <li><em>Audit Initializer</em></li>
            <li><em>Audit Writer</em></li>
            <li><em>Branch</em></li>
        </ul>
        <p>
            Drag and drop to order the sequence so that <em>Terminate</em> comes last.
        </p>
        <p>
            <img src="resources/TutorialMessageGrouping/PurchaseSequenceSteps.png" />
        </p>
    </li>
    <li>
        <p>
            Create another new sequence called <code>Pay</code>
        </p>
        <p>
            <img src="resources/TutorialMessageGrouping/PaySequence.png" />
        </p>
    </li>
    <li>
        <p>
            Using the <strong>New Step</strong> button, add the following steps to the sequence:
        </p>
        <ul>
            <li><em>Pay Invoice</em></li>
            <li><em>Audit Initializer</em></li>
            <li><em>Audit Writer</em></li>
            <li><em>Wiretap</em></li>
        </ul>
        <p>
            Again, drag and drop to order the sequence so that <em>Terminate</em> is last.
        </p>
        <p>
            <img src="resources/TutorialMessageGrouping/PaySequenceSteps.png" />
        </p>
    </li>
    <li>
        <p>
            On the <code>Purchase</code> Sequence, click <strong>Configure</strong> next to the
            <em>Audit Initializer</em> process.
        </p>
        <p>
            To display the dynamic field picker, click
            <strong>Change Dynamic Group Identifier</strong>. From the SObject dropdown, select
            Purchase Invoice (<code>PurchaseInvoice__c</code>). Next, select the invoice reference
            reference field (<code>InvoiceReference__c</code>) from the field dropdown.
        </p>
        <p>
            <img src="resources/TutorialMessageGrouping/LogConfigurationPurchase.png" />
        </p>
        <p>
            To complete the dynamic field selection definition, click <strong>Save Field</strong>
            to return to the audit configuration, which will now reflect the dynamic field you
            selected.
        </p>
        <p>
            Close the pop-up to return to the sequence builder.
        </p>
    </li>
    <li>
        <p>
            On the <code>Purchase</code> sequence, click <strong>Configure</strong> next to the
            <em>Branch</em> process.
        </p>
        <p>
            In the Sequence field, select the <code>Pay</code> sequence
        </p>
        <p>
            <img src="resources/TutorialMessageGrouping/BranchConfigurationPurchase.png" />
        </p>
        <p>
            Click <strong>Save</strong> then close the pop-up to return to the sequence builder.
        </p>
    </li>
    <li>
        <p>
            On the <code>Pay</code> Sequence, click <strong>Configure</strong> next to the <em>Audit
            Initializer</em> process.
        </p>
        <p>
            To display the dynamic field picker, click <strong>Change Dynamic Group
            Identifier</strong>. From the SObject dropdown, select Payment
            (<code>Payment__c</code>). Next select the payment reference field
            (<code>PaymentReference__c</code>) from the field dropdown.
        </p>
        <p>
            <img src="resources/TutorialMessageGrouping/LogConfigurationPayment.png" />
        </p>
        <p>
            To complete the dynamic field selection definition, click <strong>Save</strong> to
            return to the audit configuration, which will now reflect the dynamic field you
            selected.
        </p>
        <p>
            Close the pop-up to return to the sequence builder.
        </p>
    </li>
</ol>

<h2>
    Create Purchase Invoice
</h2>

<p>
    Click the <strong>Purchase Invoices</strong> tab, Click <strong>New</strong> and enter the
    reference <code>INV-09-875</code> in the InvoiceReference (<code>InvoiceReference__c</code>)
</p>

<p>
    <img src="resources/TutorialMessageGrouping/PurchaseInvoiceNew.png" />
</p>

<p>
    Click <strong>Save</strong>, then copy the Id of this Purchase Invoice to your clipboard
    for use in the next section.
</p>

<p>
    <img src="resources/TutorialMessageGrouping/BrowserAddressBar.png" />
</p>

<h2>
    Enqueue
</h2>

<p>
    All work in the Service Bus is initiated by invoking <code>System.enqueueJob</code> on a
    <code>ServiceBus.Job</code>.
</p>

<p>
    You can construct a Simple Job using the signature <code>ServiceBus.Job(String sequenceName, Id recordId)</code>.
</p>

<ul>
    <li>
        The first parameter is the name of the Sequence the message will be routed to.
    </li>
    <li>
        The second parameter is the Id of the entity that will be the subject of processing.
    </li>
</ul>

<p>
    To simulate the processing of the fake Purchase Invoice, we will enqueue the Purchase Invoice from the Anonymous execute window.
</p>

<ol>
    <li>
        Click Setup &gt; Developer Console
    </li>
    <li>
        Hit <code>Ctrl+E</code> (Windows) or <code>Cmd+E</code> (Mac) to open the Execute Anonymous window
    </li>
    <li>
        <p>
            Enter <code>System.enqueueJob(new ServiceBus.Job('Purchase', 'a0Pb0000004AAo5'));</code>
        </p>
        <fieldset>
            <legend>Note</legend>
            The 'a0Pb0000004AAo5' represents the Purchase Invoice Id copied to your clipboard earlier.
        </fieldset>
        <p>
            <img src="resources/TutorialMessageGrouping/AnonymousExecute.png" />
        </p>
    </li>
</ol>

<h2>
    Review
</h2>

<p>
    You will receive an email from the <em>Wiretap</em> process that exists near the end of the Pay Sequence.
</p>

<ol>
    <li>
        On the <code>Purchase</code> sequence, click <strong>Configure</strong> next to the <em>Audit Initializer</em> process.
    </li>
    <li>
        Then on the configuration pop-up, click <strong>List Log Groups</strong>.
    </li>
    <li>
        Observe how this view reconciles the progress of the message, and surfacing a log entry wherever a <em>Log Writer</em> process is encountered.
    </li>
    <li>
        <p>
            Further, see how the unrelated Purchase and Payment appear under a common Log Group.
        </p>
        <p>
            <img src="resources/TutorialMessageGrouping/LogWriterEntriesPurchase.png" />
        </p>
    </li>
</ol>