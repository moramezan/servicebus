<h1>
    Service Summary
</h1>

<!--
 ! Marker Interface, Marker Inner Class, Marker Properties are all "Annotations" (not in Java sense)
 ! There are some other good phraseology here like "Trait" (compile time) and "Mixin" (run time)
 !-->

<!--
 ! Trying not to say "Service" unless we refer to "ApexClass"
 ! I like also "Service Definition" ... do we change the label?
 !-->

<p>
    In ESB, a process defines a single piece logic with inputs, outputs, and documentation. The logic
    is contained in an Apex Class. Markers in the Apex Class surface special traits.
</p>

<p>
    Any Apex Class that contains Process Markers can be discovered in order to become a
    process. The description of the process must be provided in a Marker Inner Class.
</p>

<p>
    Additional markers indicate which ESB traits a process has adopted. This example class extends
    the <a href="?topic=ApiBaseProcess">base process</a> to show a bare minimum process:
</p>

<pre>
global with sharing class ExampleProcess extends BaseProcess {
    
    //ESB Marker Inner Class
    global class ESB {
        String Description = 'Outputs one event identical to the input event.';
    }
    
    //add logic here and emit output events
    override protected List&lt;Map&lt;String,Object&gt;&gt; execute(Map&lt;String,Object&gt; inputEvent) {
        return new List&lt;Map&lt;String,Object&gt;&gt;{inputEvent};
    }
}
</pre>

<h1>
    Marker Inner Class
</h1>

<!--
 ! TODO
 ! - link to Chunking
 ! - link to Callouts
 !-->

<p>
    The presence of a Marker Inner Class in any top-level Apex Class will make that class
    discoverable as a process. The Marker Inner Class affects how the process is executed and
    is used to generate user interfaces for step configuration.
</p>

<dl>
    <dt>Description</dt>
    <dd><strong>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></strong></dd>
    <dd><strong>Required description that explains what this process does in simple terms.</strong></dd>
    
    <dt>Tag</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Optional grouping tag that can be used to categorize related processes together.</dd>
    
    <dt>Name</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Optional friendly name to be used instead of the fully-qualified Apex Class name.</dd>
    
    <dt>Icon</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Optional icon name from the <a href="resources/Api/index_abc.png" target="_blank">Silk library</a> that will display alongside steps of this process type.</dd>
    
    <dt>Cardinality</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Optional indicator of the ratio of output events to input events: eg <code>Fewer</code> outputs (Gate), <code>Zero</code> for no outputs (Terminate), <code>One</code> for a single output (Wiretap), <code>Many</code> for a split.</dd>

    <dt>HelpUrl</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Optional link to process help. This will be displayed alongside steps of this process type.</dd>
    
    <dt>Limits</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">Integer</a></dd>
    <dd>Optional number of times this process can run in one execution context, while leaving at least half of all governors. For example, <code>100</code> for a process that only issues a SOQL query.</dd>

    <dt>Inputs</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_map.htm" target="_blank">Map</a>&lt;String,String&gt;</dd>
    <dd>Optional friendly descriptions of the input event parameters required by this process.</dd>
    
    <dt>Outputs</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_map.htm" target="_blank">Map</a>&lt;String,String&gt;</dd>
    <dd>Optional friendly descriptions of the output event parameters emitted by this process. (Not to be confused with events themselves, of which a process may emit zero, one or many.)</dd>
    
    <dt>ServiceSetting</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_custom_settings.htm" target="_blank">SObject</a></dd>
    <dd>Optional <em>prototype object</em> of a Custom Setting to be used for Process-specifics settings. Data of this type are manageable on each process, and are surfaced inside the Sequence Builder.</dd>
    
    <dt>StepConfig</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_sobject.htm" target="_blank">SObject</a></dd>
    <dd>Optional <em>prototype object</em> of a Custom Object to be used for Step-specific config. Records of this type are editable on each step, and are surfaced inside the Sequence Builder.</dd>
</dl>

<p>
    This example Marker Inner Class uses all of the above:
</p>

<pre>
//ESB Marker Inner Class
global class ESB {
    String Description = 'This process tweets from a Twitter account.';
    String Tag = 'Social';
    String Name = 'Twitter';
    String Icon = 'comment';
    Integer Cardinality = 1; //one input event always emits exactly one output event
    String HelpUrl = Page.TwitterHelp.getUrl();
    String Limits = 25; //leave half of 50 (Total number of HTTP callouts permitted)
    Map&lt;String,Object&gt; Inputs = new Map&lt;String,Object&gt;{'acme__Body' => 'String of the tweet body.'};
    Map&lt;String,Object&gt; Outputs = new Map&lt;String,Object&gt;{'acme__TweetId' => 'String of tweet Id.'}
    SObject ServiceSetting = TwitterSetting__c.SObjectType.newSObject();
    SObject StepConfig = TwitterConfig__c.SObjectType.newSObject();
}
</pre>

<h1>
    Marker Properties
</h1>

<p>
    These properties on an Apex Class may be populated by an ESB process. They can be read during execution.
</p>

<dl>
    <dt>Event</dt>
    <dd><strong>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></strong></dd>
    <dd><strong>Required property containing the map of input event parameters, in JSON serialized form.</strong></dd>
    
    <dt>StepConfig</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">Custom Object</a></dd>
    <dd>Concrete custom object whose fields are populated with any Step-specific configuration, if that trait is adopted by this process.</dd>
    
    <dt>AllowsCallouts</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_boolean.htm" target="_blank">Boolean</a></dd>
    <dd>False when handling execution logic and true when handling callout logic, if that trait is adopted by this process.</dd>
</dl>

<p>
    Example
</p>

<pre>
//ESB Marker Properties
global String Event;
global TwitterConfig__c StepConfig;
global Boolean AllowsCallouts;
</pre>


<h1>
    Marker Methods
</h1>

<h2>
    callouts
</h2>

<p>
    Optional method, implemented for processes that perform callouts.
</p>

<p>
    <code>override protected void callouts(Map&lt;String,Object&gt; inputEvent)</code>
</p>

<p>
    Any web services or HTTP callouts must be performed via this method. The response body
    can be shared with the <code>execute</code> method by using class properties. For example:
</p>

<pre>
override protected void callouts(Map&lt;String,Object&gt; inputEvent) {
    HttpRequest request = new HttpRequest();
    request.setEndpoint('http://headers.jsontest.com/');
    request.setMethod('GET');
    this.Content = new Http().send(request).getBody();
}
</pre>

<h2>
    execute
</h2>

<p>
    Required method that contains the executable logic of an ESB process.
</p>

<p>
    <code>override protected List&lt;Map&lt;String,Object&gt;&gt; execute(Map&lt;String,Object&gt; inputEvent)</code>
</p>

<p>
    Any DML operations must be performed via this method. Returns a list of zero, one or many output events.
</p>

<pre>
override protected List&lt;Map&lt;String,Object&gt;&gt; execute(Map&lt;String,Object&gt; inputEvent) {
    Map&lt;String,Object&gt; outputEvent = inputEvent.clone();
    outputEvent.put('c__Debug', 'Hello world!');
    return new List&lt;Map&lt;String,Object&gt;&gt;{outputEvent};
}
</pre>

<h1>
    Marker Interfaces
</h1>

<h2>
    Database.AllowsCallouts
</h2>

<p>
    Indicates this process will attempt to make HTTP callouts.
</p>

<p>
    This marker interface has no methods. See example:
</p>

<pre>
//ESB Marker Interface
global with sharing class TwitterProcess extends BaseProcess implements Database.AllowsCallouts {
    
    //ESB Marker Inner Class
    global class ESB {
        String Description = 'Makes an HTTP callout then performs some DML.';
    }
     
    override protected void callouts(Map&lt;String,Object&gt; inputEvent) {
        //http callouts here (called first)
    }
    
    override protected List&lt;Map&lt;String,Object&gt;&gt; execute(Map&lt;String,Object&gt; inputEvent) {
        //dml operations here (called second)
        return new List&lt;Map&lt;String,Object&gt;&gt;{inputEvent};
    }
}
</pre>
