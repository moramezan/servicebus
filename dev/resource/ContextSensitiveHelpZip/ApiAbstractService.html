<h1>
    Abstract Service
</h1>

<!--
 ! Trying not to say "Service" unless we refer to "ApexClass"
 ! I like also "Service Definition" ... do we change the label?
 !-->

<p>
    All the traits available to service authors can be availed using
    <a href="?topic=ApiServiceSummary">Service Summary</a> and the <code>toString</code> marker
    method.
</p>

<p>
    However, you may wish to define an abstract service class to handle common code such as serialization,
    deserialization and callouts.
</p>

<p>
    This example abstract service class simplifies the use of markers, and is used throughout tutorials and documentation:
</p>

<pre>
abstract public with sharing class AbstractService {
    
    //only override when a service requires callouts
    @TestVisible virtual protected void callouts(Map&lt;String,Object&gt; event) {}
    
    //always override and implement service logic inside
    @TestVisible abstract protected List&lt;Map&lt;String,Object&gt;&gt; execute(Map&lt;String,Object&gt; event);
    
    //ESB Marker Properties
    public String Event;
    
    //ESB Marker Method
    override public String toString() {
        Map&lt;String,Object&gt; inputEvent = (Map&lt;String,Object&gt;)Json.deserializeUntyped(this.Event);
        Boolean allowsCallouts = (Boolean)inputEvent.get('esb__AllowsCallouts');
        if (allowsCallouts == true) {this.callouts(inputEvent);return null;}
        return Json.serialize(this.execute(inputEvent));
    }
    
}
</pre>

<fieldset>
    <legend>Note</legend>
    The error recovery capability of ESB ensures state can be persisted to the database before and after execution.
    <br /><br />
    Returning the serialized output events via <code>toString</code> ensures that event parameters only carry persistable data.
</fieldset>