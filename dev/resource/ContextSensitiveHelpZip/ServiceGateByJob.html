<!DOCTYPE html>
<html>
<head>
    <title></title>
</head>
<body>

</body>
</html>                              <h1>
    Gate By Job service
</h1>

<dl>
    <dt>AggregateQuery</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Query string for locating the records correlated by the Aggregate service. Use <code>Database.query</code> and cast the result to <code>List&lt;sObject&gt;</code>.</dd>
    
    <dt><!-- TODO --></dt>
    
    <dt>AggregateField</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_list.htm" target="_blank">List&lt;Map&lt;String,Object&gt;&gt;</a></dd>
    <dd>Field name on the stored items that contains the serialized event data. Use <code>sobject.get()</code> to dereference it, then cast to <code>Map&lt;String,Object&gt;</code> when deserializing the value.</dd>
</dl>

<p>
<ul>
    <li>A related collection of messages may proceed down the same sequence
        in separate execution contexts.
        <br/>For most requirements, this is acceptable and desired behaviour but
        a need may  arise for a downstream service <em>to act on these related messages in a single
            transaction context</em>.
    </li>
    <li>An <code>GateByJob</code> service enables the above scenario by utilising
        the <code>Job Id</code> field as a grouping key on all related messages.
        <br/>(All messages carry the same unique
        value in this field when enqueued at the same time.)
    </li>
</ul>

</p>

<p> <br/> </p>

<h2>
    Scenario
</h2>

<p>
    Consider a collection of 30 related events that are enqueued simultaneously.
<ul>
    <li>Each event signals the execution of an asynchronous downstream service that for example,
        analyses the internal strength of a specific jet engine fan blade referenced by the event.
    </li>
    <li>Naturally, all 30 services must return "PASS" for the jet engine to be certified as airworthy
        but until the results of all 30 fan blades have completed, no positive decision can be
        made about the airworthiness of that jet engine.
    </li>
</ul>
</p>

<p> <br/> </p>

<h2>
    Scenario Implementation using the Gate By Job Service
</h2>
<p>

<ul>
    <li>
        The enqueue method annotates all 30 "jet blade" events with the same unique <code>Job Id</code>.
        <br/> (<strong>Note:</strong> This is standard Services framework functionality - a collection of simultaneously enqueued
        events will all receive the same <code>Job Id</code>)
    </li>
    <li>
        Each of the 30 "jet blade" events signals the (asynchronous) execution of a custom
        <code>"Blade Strength"</code> service and this custom service will emmit a useful "PASS/FAIL" result.
    </li>
    <li>
        After passing though the <code>"Blade Strength"</code> service,
        all  "jet blade" events are buffered  as and when they arrive by
        the  <code>GateByJob</code> service
    </li>
    <li>
        As soon as  all 30 "jet blade" events have arrived, the <code>GateByJob</code> service releases
        a single message that contains a handle to the cumulative results of all 30 "jet blade" events.
        With access to this handle, all subsequent downstream services are now equipped with a complete view of
        prior asynchronous events thereby enabling a valid positive assessment of the airworthiness of the jet engine
        in a single context.
    </li>
</ul>
</p>


