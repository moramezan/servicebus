<h1>
    Process Markers
</h1>

<!--
 ! Marker Interface, Marker Inner Class, Marker Properties are all "Annotations" (not in Java sense)
 ! There are some other good phraseology here like "Trait" (compile time) and "Mixin" (run time)
 !-->

<!--
 ! Trying not to say "Process" unless we refer to "Process__c"
 ! I like also "Process Definition" ... do we change the label?
 !-->

<p>
    An ESB Process defines a single piece logic with inputs, outputs, and documentation. The logic
    is contained in an Apex Class. Markers in the Apex Class surface other aspects.
</p>

<p>
    Any Apex Class that contains Process Markers can be discovered in order to become a
    process. The description of the process must be provided in a Marker Inner Class.
</p>

<p>
    Additional markers indicate which ESB features a process has adopted. This example class uses
    the minimum necessary markers:
</p>

<pre>
global with sharing class ExampleProcess {
    
    //ESB Marker Properties
    global String Event;
    
    //ESB Marker Inner Class
    global class ESB {
        global String Description = 'Outputs one event identical to the input event.';
    }
    
    //ESB Marker Method
    override global String toString() {
        //add logic here and emit outputs
        return '[{}]';
    }
}
</pre>

<h1>
    Marker Inner Class
</h1>

<!--
 ! TODO
 ! - link to Chunking
 ! - link to Callouts
 !-->

<p>
    The presence of a Marker Inner Class in any top-level Apex Class will make that class
    discoverable as a process. The Marker Inner Class affects how the process is invoked and
    is used to generate user interfaces for step configuration.
</p>

<dl>
    <dt>Description</dt>
    <dd><strong>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></strong></dd>
    <dd><strong>Required description that succinctly explains what this process does.</strong></dd>
    
    <dt>Tag</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Optional grouping tag that can be used to align related processes together.</dd>
    
    <dt>Name</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Optional friendly name to be used instead of the fully-qualified Apex Class name.</dd>
    
    <dt>Icon</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Optional icon name from the <a href="resources/Api/index_abc.png" target="_blank">Silk library</a> that will display alongside steps of this process type.</dd>
    
    <dt>Cardinality</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_integer.htm" target="_blank">Integer</a></dd>
    <dd>Optional indicates the expected ratio of output events to input events: <code>-1</code> for fewer outputs (eg Gate), <code>0</code> for no outputs (eg Terminate), <code>1</code> for a single output (eg Audit), <code>null</code> for any or many.</dd>

    <dt>HelpUrl</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></dd>
    <dd>Optional Help link that will be displayed alongside steps of this process type.</dd>
    
    <dt>Limits</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">Integer</a></dd>
    <dd>Optional number of times this process can run within the governor limits.</dd>
    
    <dt>Inputs</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_map.htm" target="_blank">Map</a>&lt;String,String&gt;</dd>
    <dd>Optional friendly descriptions of the input event parameters required by this process.</dd>
    
    <dt>Outputs</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_map.htm" target="_blank">Map</a>&lt;String,String&gt;</dd>
    <dd>Optional friendly descriptions of the output event parameters emitted by this process. (Not to be confused with events themselves, of which a process may emit zero, one or many.)</dd>
    
    <dt>ProcessSetting</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_custom_settings.htm" target="_blank">SObject</a></dd>
    <dd>Optional Custom Setting <em>prototype object</em>. Data of this type are manageable on each process, to surface Process-wide settings inside the Sequence Builder.</dd>
    
    <dt>StepConfig</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_sobject.htm" target="_blank">SObject</a></dd>
    <dd>Optional Custom Object <em>prototype object</em>. Records of this type are editable on each step, to surface Step-specific configs inside the Sequence Builder.</dd>
</dl>

<p>
    This example Marker Inner Class uses all of the above:
</p>

<pre>
//ESB Marker Inner Class
global class ESB {
    global String Description = 'This process tweets from a Twitter account.';
    global String Tag = 'Twitter';
    global String Name = 'Tweet';
    global String Icon = 'comment';
    global Integer Cardinality = 1; //one input event always emits exactly one output event
    global String HelpUrl = Page.TwitterTweetHelp.getUrl();
    global String Limits = 25; //leave half of 50 (Total number of HTTP callouts permitted)
    global Map&lt;String,Object&gt; Inputs = new Map&lt;String,Object&gt;{'acme__Body' => 'String of the tweet body.'};
    global Map&lt;String,Object&gt; Outputs = new Map&lt;String,Object&gt;{'acme__TweetId' => 'String of tweet Id.'}
    global SObject ProcessSetting = TwitterTweetSetting__c.SObjectType.newSObject();
    global SObject StepConfig = TwitterTweetConfig__c.SObjectType.newSObject();
}
</pre>

<h1>
    Marker Properties
</h1>

<p>
    Apex class supporting various process traits will have these properties populated prior to invocation.
</p>

<dl>
    <dt>Event</dt>
    <dd><strong>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">String</a></strong></dd>
    <dd><strong>Required property containing the map of input event parameters, in JSON serialized form.</strong></dd>
    
    <dt>StepConfig</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_string.htm" target="_blank">Custom Object</a></dd>
    <dd>Concrete custom object whose fields are populated with any Step-specific configuration, if that trait is adopted by this process.</dd>
    
    <dt>AllowsCallouts</dt>
    <dd>Type: <a href="https://www.salesforce.com/us/developer/docs/apexcode/Content/apex_methods_system_boolean.htm" target="_blank">Boolean</a></dd>
    <dd>False when handling invocation logic and true when handling callout logic, if that trait is adopted by this process.</dd>
</dl>

<p>
    Example
</p>

<pre>
//ESB Marker Properties
global String Event;
global MyConfig__c StepConfig;
global Boolean AllowsCallouts;
</pre>


<h1>
    Marker Methods
</h1>

<h2>
    toString
</h2>

<p>
    Required method that contains the invokable logic of an ESB process. Returns the list of output events in JSON serialized form.
</p>

<p>
    <code>global override String toString()</code>
</p>

<fieldset>
    <legend>Note</legend>
    The error recovery features of ESB ensure that state can be persisted before and after invocation.
    <br /><br />
    Returning the output events in this serialized form ensures event parameters only carry persistable data.
</fieldset>

<pre>
override global String toString() {
    Map&lt;String,Object&gt; event = new Map&lt;String,Object&gt;();
    event.put('c__OutputParameter', 'somevalue');
    
    List&lt;Map&lt;String,Object&gt;&gt; events = new List&lt;Map&lt;String,Object&gt;&gt;();
    events.add(event);
    
    //zero, one or many outputs
    return Json.serialize(events);
}
</pre>

<h1>
    Marker Interfaces
</h1>

<h2>
    Database.AllowsCallouts
</h2>

<p>
    Indicates this process will attempt to make HTTP callouts.
</p>

<p>
    This marker interface has no methods. See example:
</p>

<pre>
global with sharing class TwitterTweet implements Database.AllowsCallouts {
    
    //ESB Marker Properties
    global String Event;
    global Boolean AllowsCallouts;
     
    //ESB Marker Inner Class
    global class ESB {
        global String Description = 'Makes an HTTP callout then performs some DML.';
    }
     
    //ESB Marker Method
    override global String toString() {
        if (this.AllowsCallouts) {
            //http callouts here
            return null;
        } else {
            //dml operations here
            return '[{}]';
        }
    }
}
</pre>
